<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.purple.demo.mapper.FeedMapper">
    <select id="selFeedList" resultType="FeedListDTO">
        SELECT a.feed_pk, a.feed_ctnt, a.feed_writedate, a.feed_userpk,
        b.user_id, b.user_profileimg,
        (SELECT COUNT(comment_pk) FROM comment WHERE comment_feedpk = a.feed_pk) AS "comment_count",
        (SELECT COUNT(favorite_feedpk) FROM favorite WHERE favorite_feedpk= a.feed_pk) AS "favorite_count"
        FROM feed AS a
        LEFT OUTER JOIN user AS b
        ON (a.feed_userpk = b.user_pk)
        WHERE a.feed_state = 1
        ORDER BY a.feed_writedate DESC
        LIMIT 0, 5;
    </select>

    <select id="selMediaList" resultType="MediaEntity">
        SELECT b.media_url
        FROM feed AS a
        INNER JOIN media AS b
        ON (a.feed_pk = b.media_feedpk)
        WHERE a.feed_pk = #{feed_pk}
    </select>

    <select id="selHashtagList" resultType="HashtagEntity">
        SELECT a.hashtag_ctnt
        FROM hashtag AS a
        INNER JOIN hashtag_relation AS b
        ON(a.hashtag_pk = b.htrel_hashtagpk)
        INNER JOIN feed AS c
        ON (b.htrel_feedpk = c.feed_pk)
        WHERE c.feed_pk = #{feed_pk}
    </select>

    <select id="isFavorite" resultType="int">
        SELECT count(bookmark_feedpk)
        FROM bookmark
        WHERE bookmark_feedpk=#{feed_pk} AND bookmark_userpk=#{user_pk};
    </select>

    <select id="isBookmark" resultType="_int">
        SELECT count(favorite_feedpk)
        FROM favorite
        WHERE favorite_feedpk=#{feed_pk} AND favorite_userpk=#{user_pk};
    </select>

    <!-- 글 쓰기 -->
    <insert id="insfeed">
		INSERT INTO feed
		( feed_pk, feed_ctnt, feed_userpk )
		VALUES
		( #{feed_pk}, #{feed_ctnt}, 1 )
	</insert>

    <insert id="inshastag">
        INSERT INTO hashtag
        ( hashtag_pk, hashtag_ctnt )
        VALUES
        ( #{hashtag_pk}, #{hashtag_ctnt} )
    </insert>
</mapper>